<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>aviary.env &#8212; aviary  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for aviary.env</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">Self</span><span class="p">,</span> <span class="n">TypeAlias</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseModel</span><span class="p">,</span>
    <span class="n">ConfigDict</span><span class="p">,</span>
    <span class="n">Field</span><span class="p">,</span>
    <span class="n">JsonValue</span><span class="p">,</span>
    <span class="n">ValidationInfo</span><span class="p">,</span>
    <span class="n">WrapSerializer</span><span class="p">,</span>
    <span class="n">field_validator</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">aviary.message</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">aviary.tools</span> <span class="kn">import</span> <span class="n">Tool</span><span class="p">,</span> <span class="n">ToolCall</span><span class="p">,</span> <span class="n">ToolRequestMessage</span><span class="p">,</span> <span class="n">ToolResponseMessage</span>
<span class="kn">from</span> <span class="nn">aviary.utils</span> <span class="kn">import</span> <span class="n">is_coroutine_callable</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># TODO: make TypeVar after https://github.com/pydantic/pydantic/milestone/13</span>
<span class="c1"># NOTE: can&#39;t use pydantic.JsonValue here because it will deep copy all the way</span>
<span class="c1"># down JSON, and we want to support shallow copying capability</span>
<span class="n">Serializable</span><span class="p">:</span> <span class="n">TypeAlias</span> <span class="o">=</span> <span class="nb">dict</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">BaseModel</span>


<div class="viewcode-block" id="Frame">
<a class="viewcode-back" href="../../core.html#core.Frame">[docs]</a>
<span class="k">class</span> <span class="nc">Frame</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A frame is a snapshot at a given timestep. The name comes from video frame.&quot;&quot;&quot;</span>

    <span class="n">deepcopy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Whether to deepcopy the state and info fields. &quot;</span>
            <span class="s2">&quot;Disable if you&#39;re sure they&#39;re immutable or desire mutability.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_custom_serializer</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Serializable</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>  <span class="c1"># noqa: ARG004</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">state</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Serializable</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">WrapSerializer</span><span class="p">(</span><span class="n">_custom_serializer</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Either entire (or a subset of) the current state. Leave as default of None&quot;</span>
            <span class="s2">&quot; if state is irrelevant.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">info</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Serializable</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">WrapSerializer</span><span class="p">(</span><span class="n">_custom_serializer</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional metadata that doesn&#39;t vary with state.&quot;</span>
    <span class="p">)</span>

<div class="viewcode-block" id="Frame.make_deepcopy">
<a class="viewcode-back" href="../../core.html#core.Frame.make_deepcopy">[docs]</a>
    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_deepcopy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">Serializable</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">ValidationInfo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Serializable</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deepcopy&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span></div>
</div>



<span class="c1"># NOTE: setting to None means there is no state</span>
<span class="n">TEnvState</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;TEnvState&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Environment">
<a class="viewcode-back" href="../../core.html#core.Environment">[docs]</a>
<span class="k">class</span> <span class="nc">Environment</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">TEnvState</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An environment is a stateful place where agents use tools and make observations.</span>

<span class="sd">    Tools are housed in the environment because they can interact with the environment.</span>

<span class="sd">    Environments (and their contained tools) are not trainable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tool</span><span class="p">]</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">TEnvState</span>

<div class="viewcode-block" id="Environment.step">
<a class="viewcode-back" href="../../core.html#core.Environment.step">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">ToolRequestMessage</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take a step in the environment.</span>

<span class="sd">        Args:</span>
<span class="sd">            action: Action to take.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Four-tuple of new observations, instantaneous reward for this action, a flag</span>
<span class="sd">                symbolizing if the episode is done, and a flag symbolizing if the</span>
<span class="sd">                episode was truncated (e.g. via early stopping).</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Environment.reset">
<a class="viewcode-back" href="../../core.html#core.Environment.reset">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tool</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the environment and collect initial observation(s).</span>

<span class="sd">        Possible observations could be instructions on how tools are related,</span>
<span class="sd">        or the goal of the environment.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Two-tuple of initial observations and tools.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Environment.filter_invalid_tool_calls">
<a class="viewcode-back" href="../../core.html#core.Environment.filter_invalid_tool_calls">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_invalid_tool_calls</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">ToolRequestMessage</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ToolRequestMessage</span><span class="p">,</span> <span class="n">ToolRequestMessage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split a list of tool calls into valid and invalid subsets.</span>

<span class="sd">        Args:</span>
<span class="sd">            message: Tool request message containing tool calls.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Two-tuple of ToolRequestMessage containing valid messages and</span>
<span class="sd">                ToolRequestMessage containing invalid messages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span><span class="p">,</span> <span class="n">invalid</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
            <span class="n">tool_used_in_tool_call</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">tool_used_in_tool_call</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_call</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">invalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_call</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">[</span><span class="n">ToolRequestMessage</span><span class="p">,</span> <span class="n">ToolRequestMessage</span><span class="p">],</span>
            <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">ToolRequestMessage</span><span class="p">(</span>
                    <span class="n">role</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
                    <span class="n">function_call</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">function_call</span><span class="p">,</span>
                    <span class="n">tool_calls</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">invalid</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Environment.exec_tool_calls">
<a class="viewcode-back" href="../../core.html#core.Environment.exec_tool_calls">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">exec_tool_calls</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">message</span><span class="p">:</span> <span class="n">ToolRequestMessage</span><span class="p">,</span>
        <span class="n">ordered</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">handle_tool_exc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">function_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ToolResponseMessage</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute an ordered list of tool calls.</span>

<span class="sd">        Args:</span>
<span class="sd">            message: ToolRequestMessage containing the tool calls.</span>
<span class="sd">            ordered: Opt-in flag for forcing sequential execution (according to order</span>
<span class="sd">                in the above message), otherwise tool calls are made concurrently.</span>
<span class="sd">            handle_tool_exc: Opt-in flag to suppress Exceptions and return them as a</span>
<span class="sd">                ToolResponseMessage.</span>
<span class="sd">            **function_kwargs: Keyword arguments to pass to all tool functions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Ordered list of ToolResponseMessages, order matches the order of tool calls</span>
<span class="sd">                in the input message.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_exec_tool_call</span><span class="p">(</span><span class="n">tool_call</span><span class="p">:</span> <span class="n">ToolCall</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ToolResponseMessage</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tool</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tool_call</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> not a valid name in&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="w"> </span><span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">}</span><span class="w"> </span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
            <span class="c1"># we do a special convenience to make</span>
            <span class="c1"># state be optional in the function signature</span>
            <span class="n">need_to_filter</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;state&quot;</span> <span class="ow">in</span> <span class="n">function_kwargs</span>
                <span class="ow">and</span> <span class="s2">&quot;state&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">_tool_fn</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">_tool_fn</span><span class="p">,</span> <span class="s2">&quot;requires_state&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">filtered_kwargs</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">function_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;state&quot;</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">need_to_filter</span>
                <span class="k">else</span> <span class="n">function_kwargs</span>
            <span class="p">)</span>
            <span class="n">tool_exc</span><span class="p">:</span> <span class="ne">Exception</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_coroutine_callable</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">_tool_fn</span><span class="p">):</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool</span><span class="o">.</span><span class="n">_tool_fn</span><span class="p">(</span>
                        <span class="o">**</span><span class="n">tool_call</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">filtered_kwargs</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If the function is synchronous, run on a thread</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span>
                        <span class="n">tool</span><span class="o">.</span><span class="n">_tool_fn</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">tool_call</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">filtered_kwargs</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">handle_tool_exc</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="n">logger_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Encountered exception during tool call for tool </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">exc</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># logger.exception is just too verbose and clogs up console logging. This is a</span>
                <span class="c1"># more human-friendly version: log a readable error message and emit the exception</span>
                <span class="c1"># at DEBUG level.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">logger_msg</span><span class="p">)</span>  <span class="c1"># noqa: TRY400</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">tool_exc</span> <span class="o">=</span> <span class="n">exc</span>
            <span class="k">if</span> <span class="n">tool_exc</span><span class="p">:</span>
                <span class="c1"># No need to mention tool.info.name here, since it&#39;ll get wrapped in a ToolResponseMessage</span>
                <span class="n">s_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Encountered exception during tool call: </span><span class="si">{</span><span class="n">tool_exc</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">s_content</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
                <span class="n">s_content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">by_alias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Fallback when content is another type, or None</span>
                <span class="n">s_content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ToolResponseMessage</span><span class="o">.</span><span class="n">from_call</span><span class="p">(</span><span class="n">tool_call</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">s_content</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ordered</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
                <span class="o">*</span><span class="p">(</span><span class="n">_exec_tool_call</span><span class="p">(</span><span class="n">tool_call</span><span class="p">)</span> <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="k">await</span> <span class="n">_exec_tool_call</span><span class="p">(</span><span class="n">tool_call</span><span class="p">)</span> <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">]</span></div>


<div class="viewcode-block" id="Environment.export_frame">
<a class="viewcode-back" href="../../core.html#core.Environment.export_frame">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">export_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Frame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export the environment as a Frame.</span>

<span class="sd">        If you are not sure what to put in the Frame, just give it the entire state.</span>
<span class="sd">        Read Field descriptions in Frame for more information.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Environment.close">
<a class="viewcode-back" href="../../core.html#core.Environment.close">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shutdown the environment.</span>

<span class="sd">        If this is unimplemented, __del__ will manage cleanup.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Environment.from_task">
<a class="viewcode-back" href="../../core.html#core.Environment.from_task">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_task</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an environment from a task description.</span>

<span class="sd">        A task is meant to be closer to a user prompt - like what you would expect</span>
<span class="sd">        in calling an LLM. This is how the environment should be used after training</span>
<span class="sd">        and in deployment. We don&#39;t take config here, because the default environment config</span>
<span class="sd">        should be general for arbitrary tasks.</span>

<span class="sd">        For example, with GSM8k/calculator: &quot;What is 18 * (number of legs on a cat) / moons of mars?&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> does not implement from_task&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.from_name">
<a class="viewcode-back" href="../../core.html#core.Environment.from_name">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">env_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an environment from the name of the class. Call `Environment.available()` to see list.&quot;&quot;&quot;</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="n">_get_cls_from_name</span><span class="p">(</span><span class="n">ENV_REGISTRY</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">env_kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot pass both a task and environment kwargs.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_cls</span><span class="o">.</span><span class="n">from_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_cls</span><span class="p">(</span><span class="o">**</span><span class="n">env_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.available">
<a class="viewcode-back" href="../../core.html#core.Environment.available">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">available</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;See list of available environment classes for `from_name`.</span>

<span class="sd">        This is not exhaustive, because some may be importable and so you should just</span>
<span class="sd">        try to call `from_name`. This is more for logging/debugging purposes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">ENV_REGISTRY</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>
</div>



<span class="c1"># Maps baseline environment names to their module and class names</span>
<span class="n">ENV_REGISTRY</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dummy&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;aviary.env&quot;</span><span class="p">,</span> <span class="s2">&quot;DummyEnv&quot;</span><span class="p">),</span>
    <span class="s2">&quot;calculator&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;aviary.envs.gsm8k.env&quot;</span><span class="p">,</span> <span class="s2">&quot;CalculatorEnv&quot;</span><span class="p">),</span>
    <span class="s2">&quot;hotpotqa&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;aviary.envs.hotpotqa.env&quot;</span><span class="p">,</span> <span class="s2">&quot;HotPotQAEnv&quot;</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">TEnvironment</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;TEnvironment&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Environment</span><span class="p">)</span>


<div class="viewcode-block" id="TaskDataset">
<a class="viewcode-back" href="../../core.html#core.TaskDataset">[docs]</a>
<span class="k">class</span> <span class="nc">TaskDataset</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">TEnvironment</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A base class for a dataset of tasks as environments.</span>

<span class="sd">    Examples of task datasets: GSM8k, HotPotQA, etc.</span>
<span class="sd">    These are related environments instances with different problem</span>
<span class="sd">    specifications and reward conditions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TaskDataset.from_name">
<a class="viewcode-back" href="../../core.html#core.TaskDataset.from_name">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">env_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskDataset</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_get_cls_from_name</span><span class="p">(</span><span class="n">TASK_DATASET_REGISTRY</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="o">**</span><span class="n">env_kwargs</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;Object of type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&quot; has no len()&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="TaskDataset.get_new_env_by_idx">
<a class="viewcode-back" href="../../core.html#core.TaskDataset.get_new_env_by_idx">[docs]</a>
    <span class="k">def</span> <span class="nf">get_new_env_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TEnvironment</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get an env from a finite dataset.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&quot; does not implement get_new_env_by_idx&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TaskDataset.get_new_env">
<a class="viewcode-back" href="../../core.html#core.TaskDataset.get_new_env">[docs]</a>
    <span class="k">def</span> <span class="nf">get_new_env</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TEnvironment</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get an env from a non-indexable dataset.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&quot; does not implement get_new_env&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TaskDataset.iter_batches">
<a class="viewcode-back" href="../../core.html#core.TaskDataset.iter_batches">[docs]</a>
    <span class="k">def</span> <span class="nf">iter_batches</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">TEnvironment</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct batches from this dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch_size: Size of each batch.</span>
<span class="sd">                Note that if this dataset&#39;s size is finite and isn&#39;t evenly divisible by</span>
<span class="sd">                this value, the last yielded batch will be smaller than batch_size.</span>
<span class="sd">            shuffle: Opt-in flag to shuffle without replacement.</span>

<span class="sd">        Yields:</span>
<span class="sd">            An iterator over batches of environments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># not a finite-length dataset, so construct an infinite iter</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_new_env</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># finite-length dataset</span>
            <span class="n">idcs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">idcs</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">idcs</span><span class="p">:</span>
                <span class="n">batch_idcs</span> <span class="o">=</span> <span class="n">idcs</span><span class="p">[:</span><span class="n">batch_size</span><span class="p">]</span>
                <span class="n">idcs</span> <span class="o">=</span> <span class="n">idcs</span><span class="p">[</span><span class="n">batch_size</span><span class="p">:]</span>
                <span class="k">yield</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_new_env_by_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">batch_idcs</span><span class="p">]</span></div>
</div>



<span class="c1"># Maps baseline task dataset names to their module and class names</span>
<span class="n">TASK_DATASET_REGISTRY</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;dummy&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;aviary.env&quot;</span><span class="p">,</span> <span class="s2">&quot;DummyTaskDataset&quot;</span><span class="p">),</span>
    <span class="s2">&quot;gsm8k&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;aviary.envs.gsm8k.env&quot;</span><span class="p">,</span> <span class="s2">&quot;GSM8kDataset&quot;</span><span class="p">),</span>
    <span class="s2">&quot;hotpotqa&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;aviary.envs.hotpotqa.env&quot;</span><span class="p">,</span> <span class="s2">&quot;HotPotQADataset&quot;</span><span class="p">),</span>
<span class="p">}</span>


<div class="viewcode-block" id="TaskConfig">
<a class="viewcode-back" href="../../core.html#core.TaskConfig">[docs]</a>
<span class="k">class</span> <span class="nc">TaskConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convenience for making a config file entry for a TaskDataset.&quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">)</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">task_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseModel</span> <span class="o">|</span> <span class="n">JsonValue</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Arguments to pass to TaskDataset.from_name()&quot;</span>
    <span class="p">)</span>
    <span class="n">train_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseModel</span> <span class="o">|</span> <span class="n">JsonValue</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Additional arguments for the training split.&quot;</span>
    <span class="p">)</span>
    <span class="n">eval_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseModel</span> <span class="o">|</span> <span class="n">JsonValue</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Additional arguments for the evaluation split.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">test_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseModel</span> <span class="o">|</span> <span class="n">JsonValue</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Additional arguments for the test split.&quot;</span>
    <span class="p">)</span>

<div class="viewcode-block" id="TaskConfig.make_dataset">
<a class="viewcode-back" href="../../core.html#core.TaskConfig.make_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">make_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskDataset</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
            <span class="n">split_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_kwargs</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_kwargs</span>
        <span class="k">elif</span> <span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;eval&quot;</span><span class="p">:</span>
            <span class="n">split_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_kwargs</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_kwargs</span>
        <span class="k">elif</span> <span class="n">split</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
            <span class="n">split_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_kwargs</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_kwargs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Didn&#39;t handle split </span><span class="si">{</span><span class="n">split</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">TaskDataset</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">split_kw</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DummyEnvState">
<a class="viewcode-back" href="../../core.html#core.DummyEnvState">[docs]</a>
<span class="k">class</span> <span class="nc">DummyEnvState</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span>
    <span class="n">reward</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="DummyEnv">
<a class="viewcode-back" href="../../core.html#core.DummyEnv">[docs]</a>
<span class="k">class</span> <span class="nc">DummyEnv</span><span class="p">(</span><span class="n">Environment</span><span class="p">[</span><span class="n">DummyEnvState</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple Environment with basic functionality and no network usage.&quot;&quot;&quot;</span>

    <span class="n">State</span> <span class="o">=</span> <span class="n">DummyEnvState</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_immediately</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_immediately</span> <span class="o">=</span> <span class="n">end_immediately</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>

<div class="viewcode-block" id="DummyEnv.from_task">
<a class="viewcode-back" href="../../core.html#core.DummyEnv.from_task">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_task</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DummyEnv</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">)</span></div>


<div class="viewcode-block" id="DummyEnv.step">
<a class="viewcode-back" href="../../core.html#core.DummyEnv.step">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">ToolRequestMessage</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="n">msgs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_tool_calls</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">msgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reward</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">done</span><span class="p">,</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="DummyEnv.reset">
<a class="viewcode-back" href="../../core.html#core.DummyEnv.reset">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Message</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tool</span><span class="p">]]:</span>
        <span class="k">def</span> <span class="nf">print_story</span><span class="p">(</span><span class="n">story</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">DummyEnvState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa: ARG001</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Print a story.</span>

<span class="sd">            Args:</span>
<span class="sd">                story: Story to print.</span>
<span class="sd">                state: Environment state.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">state</span><span class="o">.</span><span class="n">reward</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">state</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_immediately</span>

        <span class="k">def</span> <span class="nf">cast_float</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Cast the input argument x to a float.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">cast_int</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Cast the input argument x to an integer.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Tool</span><span class="o">.</span><span class="n">from_function</span><span class="p">(</span><span class="n">print_story</span><span class="p">),</span>
            <span class="n">Tool</span><span class="o">.</span><span class="n">from_function</span><span class="p">(</span><span class="n">cast_float</span><span class="p">,</span> <span class="n">allow_empty_param_descriptions</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">Tool</span><span class="o">.</span><span class="n">from_function</span><span class="p">(</span><span class="n">cast_int</span><span class="p">,</span> <span class="n">allow_empty_param_descriptions</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">State</span><span class="p">(</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
                <span class="n">Message</span><span class="p">(</span>
                    <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Write a 5 word story via print_story&quot;</span>
                    <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; about </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span></div>


<div class="viewcode-block" id="DummyEnv.export_frame">
<a class="viewcode-back" href="../../core.html#core.DummyEnv.export_frame">[docs]</a>
    <span class="k">def</span> <span class="nf">export_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Frame</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Frame</span><span class="p">(</span>
            <span class="n">state</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">content</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">messages</span><span class="p">]},</span>
            <span class="n">info</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;tool_names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">],</span>
                <span class="s2">&quot;done&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">done</span><span class="p">,</span>
                <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">reward</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DummyTaskDataset">
<a class="viewcode-back" href="../../core.html#core.DummyTaskDataset">[docs]</a>
<span class="k">class</span> <span class="nc">DummyTaskDataset</span><span class="p">(</span><span class="n">TaskDataset</span><span class="p">[</span><span class="n">DummyEnv</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A dummy task of infinite DummyEnvs.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DummyTaskDataset.get_new_env">
<a class="viewcode-back" href="../../core.html#core.DummyTaskDataset.get_new_env">[docs]</a>
    <span class="k">def</span> <span class="nf">get_new_env</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DummyEnv</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DummyEnv</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<span class="k">def</span> <span class="nf">_get_cls_from_name</span><span class="p">(</span><span class="n">registry</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">module_name</span><span class="p">,</span> <span class="n">cls_name</span> <span class="o">=</span> <span class="n">registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown environment name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c1"># TODO: before release: add install instructions per env?</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not import env from </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">; you need to install it.&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">cls_name</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">aviary</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">aviary</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, FutureHouse.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>